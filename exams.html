<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ù…Ø³ØªØ± Ø­Ù…Ø¯ÙŠ Ø¹ÙŠØ¯ | Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ V2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #00e5ff;
            --bg: #05080f;
            --card-bg: rgba(22, 30, 45, 0.7);
            --text: #ffffff;
            --accent: #ff1744;
            --success: #10b981;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background: radial-gradient(circle at top, #0d1b2a 0%, #05080f 100%); color: var(--text); min-height: 100vh; overflow-x: hidden; }

        header {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(5, 8, 15, 0.8);
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1000;
            border-bottom: 1px solid rgba(0, 229, 255, 0.2); backdrop-filter: blur(15px);
        }

        .container { max-width: 1000px; margin: 100px auto 40px; padding: 0 20px; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø£Ø¯Ù…Ù† */
        #admin-editor { display: none; background: var(--card-bg); padding: 30px; border-radius: 24px; border: 1px solid var(--primary); margin-bottom: 40px; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #2a3942; background: #0f172a; color: #fff; outline: none; }
        .q-card { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 18px; margin-top: 15px; border-right: 4px solid var(--primary); }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 12px 25px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--accent); color: #fff; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± */
        #quiz-container { display: none; background: #0b141a; padding: 35px; border-radius: 30px; border: 1px solid var(--primary); box-shadow: 0 0 50px rgba(0, 229, 255, 0.1); }
        #timer { font-size: 2.2rem; color: var(--accent); font-weight: 900; text-align: center; margin-bottom: 20px; }
        .question-text { font-size: 1.4rem; margin-bottom: 25px; color: #fff; font-weight: 700; }
        .option-btn {
            width: 100%; background: #1c2635; border: 1px solid #2d3b4f; color: #fff;
            padding: 18px; border-radius: 15px; text-align: right; cursor: pointer; margin-bottom: 10px;
        }
        .option-btn.selected { border-color: var(--primary); background: rgba(0, 229, 255, 0.2); box-shadow: 0 0 15px rgba(0,229,255,0.2); }

        /* Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙ†Ù‚Ù„ */
        .quiz-controls { display: flex; justify-content: space-between; margin-top: 30px; gap: 10px; }
        
        /* ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø®ØµØµØ© */
        .custom-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content { background: #161e2d; padding: 30px; border-radius: 25px; border: 1px solid var(--primary); text-align: center; max-width: 500px; width: 100%; }

        /* ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .result-analysis { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-box { padding: 20px; border-radius: 15px; text-align: center; font-weight: bold; }
        .stat-correct { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid var(--success); }
        .stat-wrong { background: rgba(255, 23, 68, 0.1); color: var(--accent); border: 1px solid var(--accent); }

        .review-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-top: 10px; border-right: 4px solid #ccc; }
        .review-item.correct { border-right-color: var(--success); }
        .review-item.wrong { border-right-color: var(--accent); }

        /* Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø£Ø¯Ù…Ù† */
        .table-container { background: #111b21; border-radius: 20px; overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px; text-align: center; border-bottom: 1px solid #1c2635; }
        th { background: var(--primary); color: #000; }
        
        .exam-card { background: var(--card-bg); padding: 20px; border-radius: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--glass); }

        @media (max-width: 768px) {
            .quiz-controls { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 900; color: var(--primary); font-size: 1.3rem;">ğŸ§¬ Ù…Ù†ØµØ© Ù…Ø³ØªØ± Ø­Ù…Ø¯ÙŠ Ø¹ÙŠØ¯</div>
        <div id="user-info" style="font-weight: bold; background: var(--glass); padding: 8px 15px; border-radius: 12px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </header>

    <div class="container">
        <section id="admin-editor" class="animate__animated animate__fadeIn">
            <h2 style="color: var(--primary); margin-bottom: 25px;"><i class="fas fa-magic"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h2>
            <input type="text" id="ex-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">
            <div style="display: flex; gap: 15px;">
                <input type="number" id="ex-duration" placeholder="Ø§Ù„ÙˆÙ‚Øª Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚">
                <input type="number" id="ex-attempts" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª">
            </div>
            <div id="questions-list"></div>
            <button class="btn btn-outline" onclick="addNewQuestionField()" style="margin-top: 20px; width: 100%; justify-content: center;"><i class="fas fa-plus"></i> Ø£Ø¶Ù Ø³Ø¤Ø§Ù„</button>
            <button class="btn btn-success" onclick="saveExamToDB()" style="margin-top: 15px; width: 100%; justify-content: center;"><i class="fas fa-save"></i> Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
        </section>

        <section id="exams-view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: #fff; font-weight: 900;">âš¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                <button id="admin-toggle-btn" class="btn btn-primary" style="display: none;" onclick="toggleEditor()">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
            </div>
            <div id="exams-list-container"></div>
        </section>

        <section id="quiz-container" class="animate__animated animate__fadeIn">
            <div id="timer">00:00</div>
            <div id="q-box">
                <p class="question-text" id="display-q-text"></p>
                <div id="display-options"></div>
            </div>
            
            <div class="quiz-controls">
                <button class="btn btn-outline" id="prev-btn" onclick="prevQuestion()"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button>
                <button class="btn btn-success" id="submit-btn" onclick="confirmSubmit()" style="display:none;">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ³Ù„ÙŠÙ… <i class="fas fa-check-double"></i></button>
            </div>

            <p style="text-align:center; margin-top:20px; opacity:0.6;">Ø³Ø¤Ø§Ù„ <span id="q-curr">1</span> Ù…Ù† <span id="q-total">0</span></p>
        </section>

        <section id="admin-results" class="animate__animated animate__fadeInUp">
            <h3 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-users"></i> Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                            <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                            <th>ØµØ­/Ø®Ø·Ø£</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body"></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="confirmModal" class="custom-modal">
        <div class="modal-content animate__animated animate__zoomIn">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--accent); margin-bottom: 15px;"></i>
            <h3>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ</h3>
            <p style="margin: 15px 0; opacity: 0.8;">Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ.</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-success" onclick="finishQuiz()">Ù†Ø¹Ù…ØŒ Ø³Ù„Ù… Ø§Ù„Ø¢Ù†</button>
                <button class="btn btn-danger" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="custom-modal">
        <div class="modal-content animate__animated animate__zoomIn" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2 id="final-grade-text" style="color: var(--primary);"></h2>
            <div class="result-analysis">
                <div class="stat-box stat-correct"><i class="fas fa-check"></i> ØµØ­: <span id="count-correct">0</span></div>
                <div class="stat-box stat-wrong"><i class="fas fa-times"></i> Ø®Ø·Ø£: <span id="count-wrong">0</span></div>
            </div>
            <div id="review-area" style="text-align: right; margin-top: 20px;"></div>
            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px; width: 100%;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // --- ØªÙ‡ÙŠØ¦Ø© Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:e7c9b87205cbb6fb2b4da5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const userPhone = localStorage.getItem('userLoggedIn');
        let userData = null;
        let activeExam = null;
        let timerInterval;
        let qIndex = 0;
        let userAnswers = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨

        // --- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ© ---
        if (!userPhone) {
            window.location.href = "index.html";
        } else {
            db.ref('students/' + userPhone).on('value', (snap) => {
                userData = snap.val();
                if (!userData) return;
                document.getElementById('user-info').innerText = userData.name;
                if (userPhone === "admin_master" || userData.role === "admin") {
                    document.getElementById('admin-toggle-btn').style.display = 'block';
                    document.getElementById('admin-results').style.display = 'block';
                    loadResultsForAdmin();
                }
                loadExamsList();
            });
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† ---
        function toggleEditor() {
            const ed = document.getElementById('admin-editor');
            ed.style.display = ed.style.display === 'block' ? 'none' : 'block';
        }

        let qCounter = 0;
        function addNewQuestionField() {
            qCounter++;
            const html = `
                <div class="q-card" id="q-field-${qCounter}">
                    <b>Ø³Ø¤Ø§Ù„ ${qCounter}</b>
                    <input type="text" class="q-text" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="text" class="opt-1" placeholder="Ø®ÙŠØ§Ø± 1">
                        <input type="text" class="opt-2" placeholder="Ø®ÙŠØ§Ø± 2">
                        <input type="text" class="opt-3" placeholder="Ø®ÙŠØ§Ø± 3">
                        <input type="text" class="opt-4" placeholder="Ø®ÙŠØ§Ø± 4">
                    </div>
                    <input type="text" class="q-correct" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·" style="border-color:var(--success)">
                </div>`;
            document.getElementById('questions-list').insertAdjacentHTML('beforeend', html);
        }

        function saveExamToDB() {
            const title = document.getElementById('ex-title').value;
            const duration = document.getElementById('ex-duration').value;
            const attempts = document.getElementById('ex-attempts').value;
            const cards = document.querySelectorAll('.q-card');
            let questions = [];
            cards.forEach(c => {
                questions.push({
                    text: c.querySelector('.q-text').value,
                    options: [
                        c.querySelector('.opt-1').value, c.querySelector('.opt-2').value,
                        c.querySelector('.opt-3').value, c.querySelector('.opt-4').value
                    ],
                    correctAnswer: c.querySelector('.q-correct').value
                });
            });
            db.ref('exams').push({ title, duration, maxAttempts: attempts, questions }).then(() => location.reload());
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ---
        function loadExamsList() {
            db.ref('exams').on('value', snap => {
                const container = document.getElementById('exams-list-container');
                container.innerHTML = '';
                snap.forEach(child => {
                    const ex = child.val();
                    const done = (userData.examAttempts && userData.examAttempts[child.key]) || 0;
                    container.innerHTML += `
                        <div class="exam-card">
                            <div><h3>${ex.title}</h3><p>${ex.duration} Ø¯Ù‚ÙŠÙ‚Ø© | Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${done}/${ex.maxAttempts}</p></div>
                            <button class="btn btn-primary" onclick="startExam('${child.key}')" ${done >= ex.maxAttempts ? 'disabled' : ''}>Ø§Ø¨Ø¯Ø£</button>
                        </div>`;
                });
            });
        }

        function startExam(id) {
            db.ref('exams/' + id).once('value', snap => {
                activeExam = snap.val();
                activeExam.id = id;
                userAnswers = new Array(activeExam.questions.length).fill(null);
                document.getElementById('exams-view').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'block';
                qIndex = 0;
                renderQuestion();
                startTimer(activeExam.duration * 60);
            });
        }

        function renderQuestion() {
            const q = activeExam.questions[qIndex];
            document.getElementById('display-q-text').innerText = q.text;
            document.getElementById('q-curr').innerText = qIndex + 1;
            document.getElementById('q-total').innerText = activeExam.questions.length;

            const optsDiv = document.getElementById('display-options');
            optsDiv.innerHTML = '';
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn ' + (userAnswers[qIndex] === opt ? 'selected' : '');
                btn.innerText = opt;
                btn.onclick = () => {
                    userAnswers[qIndex] = opt;
                    renderQuestion();
                };
                optsDiv.appendChild(btn);
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.getElementById('prev-btn').style.visibility = qIndex === 0 ? 'hidden' : 'visible';
            if (qIndex === activeExam.questions.length - 1) {
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('submit-btn').style.display = 'inline-flex';
            } else {
                document.getElementById('next-btn').style.display = 'inline-flex';
                document.getElementById('submit-btn').style.display = 'none';
            }
        }

        function nextQuestion() { if (qIndex < activeExam.questions.length - 1) { qIndex++; renderQuestion(); } }
        function prevQuestion() { if (qIndex > 0) { qIndex--; renderQuestion(); } }

        function startTimer(s) {
            timerInterval = setInterval(() => {
                let min = Math.floor(s / 60);
                let sec = s % 60;
                document.getElementById('timer').innerText = `${min}:${sec < 10 ? '0' + sec : sec}`;
                if (s <= 0) finishQuiz();
                s--;
            }, 1000);
        }

        function confirmSubmit() { document.getElementById('confirmModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('confirmModal').style.display = 'none'; }

        function finishQuiz() {
            clearInterval(timerInterval);
            closeModal();
            let correctCount = 0;
            let reviewHtml = '<h3>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ:</h3>';

            activeExam.questions.forEach((q, i) => {
                const isCorrect = userAnswers[i] === q.correctAnswer;
                if (isCorrect) correctCount++;
                reviewHtml += `
                    <div class="review-item ${isCorrect ? 'correct' : 'wrong'}">
                        <p><b>Ø³${i + 1}:</b> ${q.text}</p>
                        <p>Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${userAnswers[i] || 'Ù„Ù… ØªØ¬Ø¨'}</p>
                        ${!isCorrect ? `<p style="color:var(--success)">Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.correctAnswer}</p>` : ''}
                    </div>`;
            });

            const grade = ((correctCount / activeExam.questions.length) * 100).toFixed(1);
            
            // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            db.ref('students/' + userPhone + '/examAttempts/' + activeExam.id).transaction(c => (c || 0) + 1);
            db.ref('examResults').push({
                studentName: userData.name,
                studentPhone: userPhone,
                examTitle: activeExam.title,
                score: grade + "%",
                correct: correctCount,
                wrong: activeExam.questions.length - correctCount,
                details: userAnswers,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('resultModal').style.display = 'flex';
            document.getElementById('final-grade-text').innerText = "Ø¯Ø±Ø¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: " + grade + "%";
            document.getElementById('count-correct').innerText = correctCount;
            document.getElementById('count-wrong').innerText = activeExam.questions.length - correctCount;
            document.getElementById('review-area').innerHTML = reviewHtml;
        }

        function loadResultsForAdmin() {
            db.ref('examResults').on('value', snap => {
                const tbody = document.getElementById('results-table-body');
                tbody.innerHTML = '';
                snap.forEach(child => {
                    const r = child.val();
                    tbody.innerHTML = `
                        <tr>
                            <td>${r.studentName}</td>
                            <td>${r.examTitle}</td>
                            <td style="color:var(--primary)"><b>${r.score}</b></td>
                            <td><span style="color:var(--success)">${r.correct}</span> / <span style="color:var(--accent)">${r.wrong}</span></td>
                            <td><button class="btn btn-outline" style="padding:5px 10px;" onclick="alert('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª: \\n' + '${r.details.join(' | ')}')">Ø¹Ø±Ø¶</button></td>
                        </tr>` + tbody.innerHTML;
                });
            });
        }
    </script>
</body>
</html>
