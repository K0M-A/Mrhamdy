<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± | Ø£. Ø­Ù…Ø¯ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Ø³ØªØ§ÙŠÙ„ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 52, 96, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box {
            background: #1a1a2e; padding: 30px; border-radius: 10px;
            box-shadow: 0 0 20px #e94560; text-align: center; width: 300px;
        }
        .login-box input {
            width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px;
            border: 1px solid #cyan; background: #222; color: white;
        }
        .login-box button {
            background: #e94560; color: white; border: none; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold;
        }
        
        /* --- Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø³Ø¨ÙˆØ±Ø© ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ --- */
        #drawingCanvas {
            background-color: #ffffff; cursor: crosshair;
            width: 100%; height: 500px; border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); touch-action: none;
        }
        .board-container { display: flex; gap: 15px; }
        .canvas-area { flex-grow: 1; }
        .students-panel {
            width: 250px; background: #1a1a2e; padding: 15px; border-radius: 10px;
            display: none; /* ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ± ÙÙ‚Ø· */ color: white; height: 500px; overflow-y: auto;
        }
        .student-item {
            background: #0f3460; padding: 10px; margin-bottom: 10px; border-radius: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .student-item button {
            background: #e94560; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer;
        }
        .student-item button.allowed { background: #39ff14; color: black; }
        .teacher-tools { display: none; margin-bottom: 10px; background: #0f3460; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: white; margin-bottom: 20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input type="text" id="userNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ù†Ø§..." required>
            <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±..." required>
            <button id="loginBtn">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ</button>
            <p id="loginError" style="color: #e94560; display: none; margin-top: 10px;">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</p>
        </div>
    </div>

    <header class="main-header">
        <div class="logo">BIO-<span class="neon-text">HAMDY</span></div>
        <div id="userInfoDisplay" style="color: white; font-weight: bold;"></div>
        <div class="menu-wrapper" id="menuBtn">
            <div class="hamburger"></div>
        </div>
    </header>

    <nav class="side-nav" id="sideNav">
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="live.html" class="active"><i class="fas fa-video"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</a></li>
            <li><a href="exams.html"><i class="fas fa-microscope"></i> Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</a></li>
        </ul>
    </nav>

    <main class="studio-hub">
        <div class="welcome-text">
            <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <span class="cyan-text">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙŠÙˆÙŠ</span></h1>
            <p>Ø§Ø®ØªØ± Ø¨ÙŠØ¦Ø© Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¨Ø¯Ø¡</p>
        </div>

        <div class="main-options">
            <div class="opt-card green-glow" onclick="switchSystem('board')">
                <div class="icon-box"><i class="fas fa-chalkboard-teacher"></i></div>
                <h3>Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h3>
            </div>
            <div class="opt-card red-glow" onclick="switchSystem('files')">
                <div class="icon-box"><i class="fas fa-file-pdf"></i></div>
                <h3>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª</h3>
            </div>
            <div class="opt-card blue-glow" onclick="toggleChat()">
                <div class="icon-box"><i class="fas fa-comments"></i></div>
                <h3>Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
            </div>
        </div>
    </main>

    <section class="workspace" id="workspace" style="display: none;">
        <button class="back-btn" onclick="closeWorkspace()"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        
        <div id="board-system" class="sys-content">
            
            <div class="teacher-tools" id="teacherTools">
                <input type="color" id="colorPicker" value="#000000">
                <button onclick="currentSize = 2">Ù‚Ù„Ù… Ø±ÙÙŠØ¹</button>
                <button onclick="currentSize = 8">Ù‚Ù„Ù… Ø¹Ø±ÙŠØ¶</button>
                <button id="clearBoardBtn" class="danger-btn">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
            </div>

            <div class="board-container">
                <div class="canvas-area">
                    <canvas id="drawingCanvas"></canvas>
                </div>
                <div class="students-panel" id="studentsPanel">
                    <h3 style="border-bottom: 1px solid #555; padding-bottom: 10px;">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†</h3>
                    <div id="studentsList"></div>
                </div>
            </div>
        </div>

        <div id="file-system" class="sys-content" style="display: none;">
            <div class="upload-area" id="dropZone">
                <input type="file" id="fileInput" hidden accept=".pdf,image/*">
                <i class="fas fa-cloud-upload-alt"></i>
                <h2>Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø±ÙØ¹</h2>
            </div>
            <div id="previewArea"></div>
        </div>
    </section>

    <div class="chat-widget">
        <div class="chat-btn" id="chatToggleBtn" onclick="toggleChatUI()">
            <i class="fas fa-comment-dots"></i>
        </div>
        <div class="chat-container" id="chatContainer" style="display:none;">
            <div class="chat-header">
                <span><i class="fas fa-circle" style="color:#39ff14"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</span>
                <button onclick="toggleChatUI()">Ã—</button>
            </div>
            <div class="chat-messages" id="chatBox"></div>
            <div class="chat-footer">
                <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
                <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        function switchSystem(sys) {
            document.getElementById('workspace').style.display = 'block';
            document.getElementById('board-system').style.display = sys === 'board' ? 'block' : 'none';
            document.getElementById('file-system').style.display = sys === 'files' ? 'block' : 'none';
            if(sys === 'board') resizeCanvas();
        }
        function closeWorkspace() { document.getElementById('workspace').style.display = 'none'; }
        function toggleChatUI() { 
            const chat = document.getElementById('chatContainer');
            chat.style.display = chat.style.display === 'none' ? 'flex' : 'none';
        }
    </script>

    <script src="script.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, onValue, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:c40aef6b378377f72b4da5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        let myName = "";
        let isTeacher = false;
        let canIDraw = false;
        const myId = "user_" + Date.now() + Math.floor(Math.random() * 1000);

        // Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ²
        const usersRef = ref(db, "active_users");
        const myUserRef = ref(db, `active_users/${myId}`);
        const boardRef = ref(db, "board_drawings");
        const clearRef = ref(db, "board_commands/clear");
        const messagesRef = ref(db, "chat_messages");

        // ----------------------------------------------------
        // 1. Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // ----------------------------------------------------
        document.getElementById("loginBtn").onclick = () => {
            const name = document.getElementById("userNameInput").value.trim();
            const pass = document.getElementById("passwordInput").value;
            const errorText = document.getElementById("loginError");

            if (!name) { errorText.innerText = "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…Ùƒ!"; errorText.style.display = "block"; return; }

            if (pass === "2027") {
                isTeacher = true; canIDraw = true; myName = "Ø£. Ø­Ù…Ø¯ÙŠ";
                document.getElementById("teacherTools").style.display = "flex";
                document.getElementById("studentsPanel").style.display = "block";
                document.getElementById("userInfoDisplay").innerText = "ğŸ‘¨â€ğŸ« ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…";
                finishLogin();
            } else if (pass === "2026") {
                isTeacher = false; canIDraw = false; myName = name;
                document.getElementById("userInfoDisplay").innerText = `ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ${myName}`;
                finishLogin();
            } else {
                errorText.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!"; errorText.style.display = "block";
            }
        };

        function finishLogin() {
            document.getElementById("loginOverlay").style.display = "none";
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ² ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
            set(myUserRef, { name: myName, role: isTeacher ? "teacher" : "student", canDraw: canIDraw });
            onDisconnect(myUserRef).remove(); // Ù„Ù…Ø§ ÙŠÙ‚ÙÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ø³Ù…Ù‡ ÙŠØªÙ…Ø³Ø­ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            
            // Ù„Ùˆ Ù…Ø³ØªØ±ØŒ Ù†Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
            if (isTeacher) {
                onValue(usersRef, (snapshot) => {
                    const studentsList = document.getElementById("studentsList");
                    studentsList.innerHTML = "";
                    snapshot.forEach((child) => {
                        const user = child.val();
                        const uid = child.key;
                        if (user.role === "student") {
                            const div = document.createElement("div");
                            div.className = "student-item";
                            div.innerHTML = `
                                <span>${user.name}</span>
                                <button class="${user.canDraw ? 'allowed' : ''}" onclick="window.toggleStudentDraw('${uid}', ${user.canDraw})">
                                    ${user.canDraw ? 'Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©' : 'Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©'}
                                </button>
                            `;
                            studentsList.appendChild(div);
                        }
                    });
                });
            } else {
                // Ù„Ùˆ Ø·Ø§Ù„Ø¨ØŒ Ù†Ø±Ø§Ù‚Ø¨ Ø­Ø§Ù„ØªÙ‡ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ± Ø§Ø¯Ø§Ù„Ù‡ Ø¥Ø°Ù†
                onValue(myUserRef, (snapshot) => {
                    if(snapshot.exists()) {
                        canIDraw = snapshot.val().canDraw;
                        if (canIDraw) alert("Ø§Ù„Ù…Ø³ØªØ± Ø³Ù…Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø¢Ù†!");
                    }
                });
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ± Ø¹Ø´Ø§Ù† ÙŠØ¹ÙƒØ³ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø·Ø§Ù„Ø¨
        window.toggleStudentDraw = (uid, currentState) => {
            update(ref(db, `active_users/${uid}`), { canDraw: !currentState });
        };


        // ----------------------------------------------------
        // 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ©
        // ----------------------------------------------------
        const canvas = document.getElementById("drawingCanvas");
        const ctx = canvas.getContext("2d");
        window.currentSize = 2;
        let currentColor = "#000000";
        let isDrawing = false;

        window.resizeCanvas = function() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = 500;
        };
        window.addEventListener("resize", window.resizeCanvas);

        if(document.getElementById("colorPicker")) {
            document.getElementById("colorPicker").onchange = (e) => currentColor = e.target.value;
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startDrawing(e) {
            if (!canIDraw) return; // Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            isDrawing = true;
            const pos = getMousePos(e);
            push(boardRef, { type: "start", x: pos.x, y: pos.y, color: currentColor, size: window.currentSize });
            drawLocal(pos.x, pos.y, currentColor, window.currentSize, false);
        }

        function draw(e) {
            if (!isDrawing || !canIDraw) return;
            e.preventDefault();
            const pos = getMousePos(e);
            push(boardRef, { type: "draw", x: pos.x, y: pos.y, color: currentColor, size: window.currentSize });
            drawLocal(pos.x, pos.y, currentColor, window.currentSize, true);
        }

        function stopDrawing() { isDrawing = false; ctx.beginPath(); }

        function drawLocal(x, y, color, size, isPath) {
            ctx.lineWidth = size; ctx.lineCap = "round"; ctx.strokeStyle = color;
            if (!isPath) { ctx.beginPath(); ctx.moveTo(x, y); } 
            else { ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y); }
        }

        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("touchstart", startDrawing, {passive: false});
        canvas.addEventListener("touchmove", draw, {passive: false});
        canvas.addEventListener("touchend", stopDrawing);

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ù… Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        onChildAdded(boardRef, (data) => {
            const pt = data.val();
            if (pt.type === "start") { ctx.beginPath(); ctx.moveTo(pt.x, pt.y); } 
            else { drawLocal(pt.x, pt.y, pt.color, pt.size, true); }
        });

        // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ù„Ù„ÙƒÙ„ (Ù„Ù„Ù…Ø³ØªØ± Ø¨Ø³)
        if(document.getElementById("clearBoardBtn")) {
            document.getElementById("clearBoardBtn").onclick = () => {
                remove(boardRef);
                set(clearRef, Date.now());
            };
        }
        onValue(clearRef, (snapshot) => {
            if(snapshot.exists()) ctx.clearRect(0, 0, canvas.width, canvas.height);
        });


        // ----------------------------------------------------
        // 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Øª
        // ----------------------------------------------------
        const msgInput = document.getElementById("msgInput");
        const chatBox = document.getElementById("chatBox");

        document.getElementById("sendBtn").onclick = () => {
            const text = msgInput.value;
            if (text.trim() !== "") {
                push(messagesRef, { sender: myName, message: text, isTeacherMsg: isTeacher });
                msgInput.value = "";
            }
        };

        onChildAdded(messagesRef, (data) => {
            const msg = data.val();
            const div = document.createElement("div");
            div.style.padding = "8px"; div.style.borderBottom = "1px solid #ddd";
            div.innerHTML = `<strong style="color: ${msg.isTeacherMsg ? '#e94560' : '#000'}">${msg.sender}:</strong> ${msg.message}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

    </script>
</body>
</html>
