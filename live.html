<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± | Ø£. Ø­Ù…Ø¯ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Ø³ØªØ§ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø³Ø¨ÙˆØ±Ø© ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª */
        #drawingCanvas {
            background-color: #1a1a2e;
            cursor: crosshair;
            width: 100%;
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }
        .board-controls {
            display: none; /* Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ Ù„Ù„Ù…Ø¹Ù„Ù… ÙÙ‚Ø· */
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #0f3460;
            border-radius: 8px;
        }
        .student-alert {
            display: none;
            color: #e94560;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .permission-btn {
            background-color: #e94560;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .permission-btn.active {
            background-color: #39ff14;
            color: black;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="logo">BIO-<span class="neon-text">HAMDY</span></div>
        <div style="color: white; font-weight: bold;" id="userRoleDisplay"></div>
    </header>

    <nav class="side-nav" id="sideNav">
        <ul>
            <li><a href="index.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li><a href="live.html" class="active"><i class="fas fa-video"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</a></li>
            <li><a href="exams.html"><i class="fas fa-microscope"></i> Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</a></li>
        </ul>
    </nav>

    <main class="studio-hub">
        <div class="welcome-text">
            <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <span class="cyan-text">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙŠÙˆÙŠ</span></h1>
        </div>
        <div class="main-options">
            <div class="opt-card green-glow" onclick="switchSystem('board')">
                <div class="icon-box"><i class="fas fa-chalkboard-teacher"></i></div>
                <h3>Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ©</h3>
            </div>
            </div>
    </main>

    <section class="workspace" id="workspace" style="display: none;">
        <button class="back-btn" onclick="closeWorkspace()"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        
        <div id="board-system" class="sys-content">
            <div id="studentAlert" class="student-alert"><i class="fas fa-lock"></i> Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ù…Ù‚ÙÙˆÙ„Ø©ØŒ Ø§Ù„Ø´Ø±Ø­ Ù„Ù„Ù…Ø³ØªØ± ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
            
            <div class="board-controls" id="teacherControls">
                <input type="color" id="colorPicker" value="#39ff14">
                <button id="btnThin">Ù‚Ù„Ù… Ø±ÙÙŠØ¹</button>
                <button id="btnThick">Ù‚Ù„Ù… Ø¹Ø±ÙŠØ¶</button>
                <button id="btnClear" class="danger-btn">Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø©</button>
                <button id="btnPermission" class="permission-btn"><i class="fas fa-user-edit"></i> Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©</button>
            </div>
            <canvas id="drawingCanvas"></canvas>
        </div>
    </section>

    <script src="script.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ²
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:c40aef6b378377f72b4da5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ==========================================
        // 1. Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© (Ù…Ø³ØªØ± ÙˆÙ„Ø§ Ø·Ø§Ù„Ø¨)
        // ==========================================
        let isTeacher = false;
        // Ù„Ù„ØªØ¬Ø±Ø¨Ø©: Ù‡Ù†Ø³Ø£Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„ Ù…Ø§ ÙŠÙØªØ­ Ø§Ù„ØµÙØ­Ø© (Ø¨Ø¹Ø¯ÙŠÙ† Ù‡Ù†Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
        const roleStr = localStorage.getItem("userRole") || prompt("Ù„Ù„ØªØ¬Ø±Ø¨Ø©: Ø§ÙƒØªØ¨ 'Ù…Ø³ØªØ±' Ø¥Ø°Ø§ ÙƒÙ†Øª Ø§Ù„Ù…Ø¹Ù„Ù…ØŒ Ø£Ùˆ 'Ø·Ø§Ù„Ø¨' Ø¥Ø°Ø§ ÙƒÙ†Øª Ø·Ø§Ù„Ø¨");
        localStorage.setItem("userRole", roleStr);
        
        if (roleStr === "Ù…Ø³ØªØ±") {
            isTeacher = true;
            document.getElementById("userRoleDisplay").innerText = "ğŸ‘¨â€ğŸ« ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…";
            document.getElementById("teacherControls").style.display = "flex"; // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³ØªØ±
        } else {
            document.getElementById("userRoleDisplay").innerText = "ğŸ‘¨â€ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨";
            document.getElementById("studentAlert").style.display = "block"; // Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø·Ø§Ù„Ø¨
        }

        // ==========================================
        // 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© (Real-time Canvas)
        // ==========================================
        const canvas = document.getElementById("drawingCanvas");
        const ctx = canvas.getContext("2d");
        
        // Ø¶Ø¨Ø· Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = 500;
        }
        window.onload = resizeCanvas;
        window.onresize = resizeCanvas;

        let isDrawing = false;
        let currentColor = "#39ff14";
        let currentSize = 5;
        let studentsAllowedToDraw = false;

        // Ù…Ø±Ø§Ø¬Ø¹ ÙØ§ÙŠØ±Ø¨ÙŠØ² Ù„Ù„Ø³Ø¨ÙˆØ±Ø©
        const boardRef = ref(db, "board_drawings");
        const permissionRef = ref(db, "board_settings/students_can_draw");
        const clearRef = ref(db, "board_settings/clear_trigger");

        // Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø³ØªØ±
        if (isTeacher) {
            document.getElementById("colorPicker").onchange = (e) => currentColor = e.target.value;
            document.getElementById("btnThin").onclick = () => currentSize = 5;
            document.getElementById("btnThick").onclick = () => currentSize = 15;
            
            // Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨
            const btnPermission = document.getElementById("btnPermission");
            btnPermission.onclick = () => {
                studentsAllowedToDraw = !studentsAllowedToDraw;
                set(permissionRef, studentsAllowedToDraw); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ² Ù„Ù„Ø¬Ù…ÙŠØ¹
            };

            // Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø©
            document.getElementById("btnClear").onclick = () => {
                set(clearRef, Date.now()); // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ù…Ø³Ø­ Ù„Ù„ÙƒÙ„
                remove(boardRef); // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø¹Ø´Ø§Ù† Ù…ØªØ¨Ù‚Ø§Ø´ ØªÙ‚ÙŠÙ„Ø©
            };
        }

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ø·Ù„Ø§Ø¨
        onValue(permissionRef, (snapshot) => {
            studentsAllowedToDraw = snapshot.val();
            if (isTeacher) {
                const btn = document.getElementById("btnPermission");
                btn.className = studentsAllowedToDraw ? "permission-btn active" : "permission-btn";
                btn.innerHTML = studentsAllowedToDraw ? "<i class='fas fa-unlock'></i> Ø§Ù„Ø·Ù„Ø§Ø¨ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø©" : "<i class='fas fa-lock'></i> Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø©";
            } else {
                const alertMsg = document.getElementById("studentAlert");
                if (studentsAllowedToDraw) {
                    alertMsg.style.color = "#39ff14";
                    alertMsg.innerHTML = "<i class='fas fa-unlock'></i> Ø§Ù„Ù…Ø³ØªØ± Ø³Ù…Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¢Ù†!";
                } else {
                    alertMsg.style.color = "#e94560";
                    alertMsg.innerHTML = "<i class='fas fa-lock'></i> Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ù…Ù‚ÙÙˆÙ„Ø©ØŒ Ø§Ù„Ø´Ø±Ø­ Ù„Ù„Ù…Ø³ØªØ± ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹.";
                }
            }
        });

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ù…Ø± Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø©
        onValue(clearRef, (snapshot) => {
            if (snapshot.val()) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        });

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªØµØ¯ÙŠØ± Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX || e.touches[0].clientX) - rect.left,
                y: (e.clientY || e.touches[0].clientY) - rect.top
            };
        }

        function startPosition(e) {
            // Ù„Ùˆ Ù…Ø´ Ù…Ø³ØªØ±ØŒ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø´ Ù…Ø³Ù…ÙˆØ­Ù„Ù‡Ù…ØŒ Ø§Ù…Ù†Ø¹ Ø§Ù„Ø±Ø³Ù…!
            if (!isTeacher && !studentsAllowedToDraw) return;
            
            isDrawing = true;
            const pos = getMousePos(e);
            
            // Ø¥Ø±Ø³Ø§Ù„ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
            push(boardRef, { type: "start", x: pos.x, y: pos.y, color: currentColor, size: currentSize });
            drawLocal(pos.x, pos.y, currentColor, currentSize, false);
        }

        function endPosition() {
            isDrawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!isDrawing) return;
            if (!isTeacher && !studentsAllowedToDraw) return;

            e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ù…
            const pos = getMousePos(e);

            // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø³Ù… Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
            push(boardRef, { type: "draw", x: pos.x, y: pos.y, color: currentColor, size: currentSize });
            drawLocal(pos.x, pos.y, currentColor, currentSize, true);
        }

        // Ø§Ù„Ø±Ø³Ù… Ø§Ù„ÙØ¹Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
        function drawLocal(x, y, color, size, isDrawingPath) {
            ctx.lineWidth = size;
            ctx.lineCap = "round";
            ctx.strokeStyle = color;

            if (!isDrawingPath) {
                ctx.beginPath();
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³ ÙˆØ§Ù„Ù„Ù…Ø³
        canvas.addEventListener("mousedown", startPosition);
        canvas.addEventListener("mouseup", endPosition);
        canvas.addEventListener("mousemove", draw);
        
        canvas.addEventListener("touchstart", startPosition);
        canvas.addEventListener("touchend", endPosition);
        canvas.addEventListener("touchmove", draw);

        // ==========================================
        // 3. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ù… Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ² (Ù„Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø³ØªØ±)
        // ==========================================
        onChildAdded(boardRef, (data) => {
            const point = data.val();
            // Ù„Ùˆ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¬Ø§ÙŠØ© Ù…Ù† Ø¨Ø±Ù‡ØŒ Ù†Ø±Ø³Ù…Ù‡Ø§
            if (point.type === "start") {
                ctx.beginPath();
                ctx.moveTo(point.x, point.y);
            } else if (point.type === "draw") {
                drawLocal(point.x, point.y, point.color, point.size, true);
            }
        });

        // ... (ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙƒÙ…Ø§ Ù‡Ùˆ) ...
    </script>
</body>
</html>
