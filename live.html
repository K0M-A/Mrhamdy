<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاستوديو المباشر | أ. حمدي</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- ستايل شاشة تسجيل الدخول --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 52, 96, 0.98); z-index: 10000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box {
            background: #1a1a2e; padding: 40px; border-radius: 15px;
            box-shadow: 0 0 30px #e94560; text-align: center; width: 320px;
        }
        .login-box h2 { color: #fff; margin-bottom: 25px; font-family: 'Cairo', sans-serif; }
        .login-box input {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px;
            border: 1px solid #00d2ff; background: #222; color: white; outline: none;
        }
        .login-box button {
            background: #e94560; color: white; border: none; padding: 12px 20px;
            border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; font-size: 1.1rem;
            margin-top: 15px; transition: 0.3s;
        }
        .login-box button:hover { background: #ff5e78; transform: scale(1.02); }
        
        /* --- ستايل السبورة --- */
        #drawingCanvas {
            background-color: #ffffff; cursor: crosshair;
            width: 100%; height: 500px; border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); touch-action: none;
        }
        .board-container { display: flex; gap: 15px; flex-wrap: wrap; }
        .canvas-area { flex: 1; min-width: 300px; }
        .students-panel {
            width: 280px; background: #1a1a2e; padding: 15px; border-radius: 10px;
            display: none; color: white; max-height: 500px; overflow-y: auto;
        }
        .student-item {
            background: #0f3460; padding: 12px; margin-bottom: 10px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #16213e;
        }
        .student-item button {
            background: #e94560; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;
        }
        .student-item button.allowed { background: #39ff14; color: black; font-weight: bold; }
        .teacher-tools { display: none; margin-bottom: 15px; background: #0f3460; padding: 15px; border-radius: 10px; gap: 15px; align-items: center; flex-wrap: wrap; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2><i class="fas fa-user-lock"></i> دخول الاستوديو</h2>
            <input type="text" id="userNameInput" placeholder="أدخل اسمك الحقيقي..." autocomplete="off">
            <input type="password" id="passwordInput" placeholder="كلمة السر (2026 للطالب)" autocomplete="off">
            <button id="finalLoginBtn">ابدأ الآن</button>
            <p id="loginError" style="color: #ff4d4d; display: none; margin-top: 15px; font-weight: bold;"></p>
        </div>
    </div>

    <header class="main-header">
        <div class="logo">BIO-<span class="neon-text">HAMDY</span></div>
        <div id="userInfoDisplay" style="color: #39ff14; font-weight: bold; font-family: 'Cairo';"></div>
        <div class="menu-wrapper" id="menuBtn">
            <div class="hamburger"></div>
        </div>
    </header>

    <main class="studio-hub">
        <div class="main-options">
            <div class="opt-card green-glow" onclick="switchSystem('board')">
                <div class="icon-box"><i class="fas fa-chalkboard-teacher"></i></div>
                <h3>السبورة الذكية</h3>
            </div>
            </div>
    </main>

    <section class="workspace" id="workspace" style="display: none;">
        <button class="back-btn" onclick="closeWorkspace()"><i class="fas fa-times"></i> إغلاق</button>
        
        <div id="board-system" class="sys-content">
            <div class="teacher-tools" id="teacherTools">
                <label style="color: white;">اللون:</label>
                <input type="color" id="colorPicker" value="#000000">
                <button onclick="window.currentSize = 2" class="btn-tool">قلم رفيع</button>
                <button onclick="window.currentSize = 8" class="btn-tool">قلم عريض</button>
                <button id="clearBoardBtn" class="danger-btn">مسح السبورة عند الجميع</button>
            </div>

            <div class="board-container">
                <div class="canvas-area">
                    <canvas id="drawingCanvas"></canvas>
                </div>
                <div class="students-panel" id="studentsPanel">
                    <h3 style="border-bottom: 2px solid #e94560; padding-bottom: 10px; margin-bottom: 15px;"><i class="fas fa-users"></i> المتواجدون الآن</h3>
                    <div id="studentsList"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // دوال التحكم بالواجهة (Global)
        function switchSystem(sys) {
            document.getElementById('workspace').style.display = 'block';
            document.getElementById('board-system').style.display = sys === 'board' ? 'block' : 'none';
            if(sys === 'board') setTimeout(resizeCanvas, 100);
        }
        function closeWorkspace() { document.getElementById('workspace').style.display = 'none'; }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, set, onValue, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // 1. الإعدادات (ثابتة)
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:c40aef6b378377f72b4da5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // متغيرات الحالة
        let myName = "";
        let isTeacher = false;
        let canIDraw = false;
        const myId = "id_" + Math.random().toString(36).substr(2, 9);

        // مراجع الداتا بيز
        const usersRef = ref(db, "active_users");
        const myUserRef = ref(db, `active_users/${myId}`);
        const boardRef = ref(db, "board_drawings");
        const clearCmdRef = ref(db, "board_commands/clear");

        // ----------------------------------------------------
        // المراجعة الأولى: تصحيح منطق تسجيل الدخول
        // ----------------------------------------------------
        document.getElementById("finalLoginBtn").onclick = () => {
            const nameField = document.getElementById("userNameInput");
            const passField = document.getElementById("passwordInput");
            const err = document.getElementById("loginError");

            const name = nameField.value.trim();
            const pass = passField.value.trim();

            if (name.length < 2) {
                err.innerText = "برجاء كتابة الاسم بشكل صحيح";
                err.style.display = "block";
                return;
            }

            if (pass === "2027") {
                isTeacher = true; canIDraw = true; myName = "أ. حمدي (المعلم)";
                startSession();
            } else if (pass === "2026") {
                isTeacher = false; canIDraw = false; myName = name;
                startSession();
            } else {
                err.innerText = "كلمة السر خاطئة!";
                err.style.display = "block";
            }
        };

        function startSession() {
            document.getElementById("loginOverlay").style.fadeOut = "0.5s";
            setTimeout(() => document.getElementById("loginOverlay").style.display = "none", 400);
            
            document.getElementById("userInfoDisplay").innerText = "مرحباً: " + myName;

            // إرسال البيانات لفايربيز
            set(myUserRef, { name: myName, role: isTeacher ? "teacher" : "student", canDraw: canIDraw });
            onDisconnect(myUserRef).remove();

            if (isTeacher) {
                document.getElementById("teacherTools").style.display = "flex";
                document.getElementById("studentsPanel").style.display = "block";
                monitorStudents();
            } else {
                monitorMyPermission();
            }
            initCanvas();
        }

        // ----------------------------------------------------
        // المراجعة الثانية: تصحيح التحكم في الطلاب (للـ مستر)
        // ----------------------------------------------------
        function monitorStudents() {
            onValue(usersRef, (snap) => {
                const list = document.getElementById("studentsList");
                list.innerHTML = "";
                snap.forEach((child) => {
                    const user = child.val();
                    const uid = child.key;
                    if (user.role === "student") {
                        const div = document.createElement("div");
                        div.className = "student-item";
                        div.innerHTML = `
                            <span>${user.name}</span>
                            <button id="btn_${uid}" class="${user.canDraw ? 'allowed' : ''}">
                                ${user.canDraw ? 'إلغاء الإذن' : 'إعطاء إذن'}
                            </button>
                        `;
                        list.appendChild(div);
                        div.querySelector('button').onclick = () => {
                            update(ref(db, `active_users/${uid}`), { canDraw: !user.canDraw });
                        };
                    }
                });
            });
        }

        function monitorMyPermission() {
            onValue(myUserRef, (snap) => {
                if (snap.exists()) {
                    canIDraw = snap.val().canDraw;
                }
            });
        }

        // ----------------------------------------------------
        // المراجعة الثالثة: تصحيح أداء السبورة (الرسم المباشر)
        // ----------------------------------------------------
        const canvas = document.getElementById("drawingCanvas");
        const ctx = canvas.getContext("2d");
        window.currentSize = 2;

        window.resizeCanvas = () => {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = 500;
        };

        function initCanvas() {
            let drawing = false;

            const getCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            };

            const start = (e) => {
                if (!canIDraw) return;
                drawing = true;
                const { x, y } = getCoords(e);
                const color = document.getElementById("colorPicker").value;
                push(boardRef, { t: "s", x, y, c: color, s: window.currentSize });
            };

            const move = (e) => {
                if (!drawing || !canIDraw) return;
                if (e.cancelable) e.preventDefault();
                const { x, y } = getCoords(e);
                const color = document.getElementById("colorPicker").value;
                push(boardRef, { t: "d", x, y, c: color, s: window.currentSize });
            };

            const stop = () => { drawing = false; ctx.beginPath(); };

            canvas.addEventListener("mousedown", start);
            canvas.addEventListener("mousemove", move);
            window.addEventListener("mouseup", stop);
            canvas.addEventListener("touchstart", start, { passive: false });
            canvas.addEventListener("touchmove", move, { passive: false });
            canvas.addEventListener("touchend", stop);
        }

        // استقبال البيانات فوراً
        onChildAdded(boardRef, (snap) => {
            const data = snap.val();
            ctx.lineWidth = data.s;
            ctx.lineCap = "round";
            ctx.strokeStyle = data.c;

            if (data.t === "s") {
                ctx.beginPath();
                ctx.moveTo(data.x, data.y);
            } else {
                ctx.lineTo(data.x, data.y);
                ctx.stroke();
            }
        });

        // مسح السبورة
        document.getElementById("clearBoardBtn").onclick = () => {
            if (isTeacher) {
                remove(boardRef);
                set(clearCmdRef, Date.now());
            }
        };

        onValue(clearCmdRef, () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

    </script>
</body>
</html>
