<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المحاضرات | الخبير حمدي عيد</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #22c55e;
            --bg: #020617;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg);
            color: white;
            margin: 0;
            user-select: none; /* منع النسخ */
        }

        header {
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 25px 5%;
        }

        .course-card {
            background: var(--glass);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            transition: 0.3s;
        }

        .thumbnail {
            width: 100%;
            height: 180px;
            background: #1e293b;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            color: var(--primary);
        }

        .course-info { padding: 15px; }
        .course-info h3 { margin: 0 0 10px 0; font-size: 1.1rem; }
        .course-info p { font-size: 0.85rem; color: #94a3b8; height: 40px; overflow: hidden; }

        .price-tag {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .btn-watch {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        /* مٌشغل الفيديو والحماية */
        #videoPlayerContainer {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 2000;
        }

        video { width: 100%; height: 100%; }

        /* العلامة المائية العائمة */
        #watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.3);
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 2100;
            white-space: nowrap;
            font-weight: bold;
        }

        .close-video {
            position: absolute;
            top: 20px; right: 20px;
            background: rgba(255,0,0,0.5);
            color: white; border: none;
            padding: 10px 15px; border-radius: 50%;
            cursor: pointer; z-index: 2200;
        }
    </style>
</head>
<body oncontextmenu="return false;"> <header>
        <div style="display: flex; align-items: center; gap: 10px;">
            <a href="index.html" style="color: white;"><i class="fas fa-arrow-right"></i></a>
            <h2 style="font-size: 1.2rem; margin: 0;">محاضرات عالم الأحياء</h2>
        </div>
        <div id="studentBalance" style="color: #fcc419; font-weight: 900;">
            رصيدك: 0 ج.م
        </div>
    </header>

    <div class="video-grid" id="coursesList">
        </div>

    <div id="videoPlayerContainer">
        <button class="close-video" onclick="closePlayer()"><i class="fas fa-times"></i></button>
        <div id="watermark"></div>
        <video id="mainVideo" controlsList="nodownload" onplay="startWatermark()"></video>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:c40aef6b378377f72b4da5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let userData = {};

        auth.onAuthStateChanged(user => {
            if (user) {
                loadUserData(user);
                loadCourses();
            } else {
                window.location.href = "go.html";
            }
        });

        async function loadUserData(user) {
            const doc = await db.collection("users").doc(user.uid).get();
            userData = doc.data();
            document.getElementById('studentBalance').innerText = `رصيدك: ${userData.balance || 0} ج.م`;
            
            // وضع بيانات العلامة المائية
            document.getElementById('watermark').innerText = `${userData.name} - ${userData.phone}`;
        }

        async function loadCourses() {
            const snapshot = await db.collection("courses").get();
            const list = document.getElementById('coursesList');
            list.innerHTML = "";

            snapshot.forEach(doc => {
                const course = doc.data();
                const isOwned = (userData.ownedCourses || []).includes(doc.id);

                list.innerHTML += `
                    <div class="course-card">
                        <div class="thumbnail"><i class="fas fa-microscope"></i></div>
                        <div class="course-info">
                            <h3>${course.title}</h3>
                            <p>${course.description}</p>
                            <div class="price-tag">
                                <span style="font-weight:bold">${isOwned ? 'تم الشراء' : course.price + ' ج.م'}</span>
                                <button class="btn-watch" onclick="handleCourse('${doc.id}', ${course.price}, '${course.videoUrl}', ${isOwned})">
                                    ${isOwned ? 'مشاهدة الآن' : 'شراء المحاضرة'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        async function handleCourse(id, price, url, isOwned) {
            if (isOwned || userData.phone === "01111276700") {
                playVideo(url);
            } else {
                if (userData.balance >= price) {
                    if (confirm(`هل تريد خصم ${price} ج.م لمشاهدة هذه المحاضرة؟`)) {
                        const newBalance = userData.balance - price;
                        const owned = userData.ownedCourses || [];
                        owned.push(id);
                        
                        await db.collection("users").doc(auth.currentUser.uid).update({
                            balance: newBalance,
                            ownedCourses: owned,
                            totalSpent: (userData.totalSpent || 0) + price
                        });
                        alert("تم الشراء بنجاح!");
                        location.reload();
                    }
                } else {
                    alert("عذراً، رصيدك غير كافٍ. تواصل مع المستر لشحن رصيدك.");
                }
            }
        }

        function playVideo(url) {
            const player = document.getElementById('mainVideo');
            const container = document.getElementById('videoPlayerContainer');
            player.src = url;
            container.style.display = 'block';
            player.play();
        }

        function closePlayer() {
            const player = document.getElementById('mainVideo');
            player.pause();
            document.getElementById('videoPlayerContainer').style.display = 'none';
        }

        // تحريك العلامة المائية عشوائياً
        function startWatermark() {
            const mark = document.getElementById('watermark');
            setInterval(() => {
                const x = Math.random() * 70;
                const y = Math.random() * 80;
                mark.style.left = x + "%";
                mark.style.top = y + "%";
            }, 5000);
        }

        // حماية متقدمة: كشف محاولة تصوير الشاشة (عبر مفاتيح الكيبورد)
        document.addEventListener('keyup', (e) => {
            if (e.key === 'PrintScreen' || e.metaKey || e.ctrlKey) {
                alert("محاولة تصوير الشاشة تسبب الحظر التلقائي!");
                blockStudent();
            }
        });

        async function blockStudent() {
            await db.collection("users").doc(auth.currentUser.uid).update({ status: 'blocked' });
            window.location.href = "contact.html";
        }
    </script>
</body>
</html>
