<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة مستر حمدي عيد | التواصل المتقدم</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --master-neon: #00e5ff;
            --accent: #ff1744;
            --bg: #05080f;
            --glass-bg: rgba(20, 30, 40, 0.95);
            --user-msg: #1a2a3a;
            --admin-msg: #004d40;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg);
            color: var(--text); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: fixed; /* لمنع السحب العشوائي للصفحة بالكامل في iOS */
            width: 100%;
        }

        /* شاشة اختيار القناة */
        #selection-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        .select-card {
            width: 80%; max-width: 350px; background: #111b27; padding: 30px;
            border-radius: 20px; border: 1px solid var(--master-neon); text-align: center;
            cursor: pointer; transition: 0.3s;
        }
        .select-card:active { transform: scale(0.95); }
        .select-card i { font-size: 3rem; color: var(--master-neon); margin-bottom: 15px; }

        /* Blocked Screen */
        #blocked-screen { 
            position: fixed; inset: 0; background: rgba(5, 8, 15, 0.98); z-index: 9999; 
            display: none; align-items: center; justify-content: center; flex-direction: column; padding: 20px;
        }

        nav { 
            padding: 10px 15px; background: #0d141d; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 1px solid #222;
            flex-shrink: 0;
        }

        .chat-tabs { display: flex; background: #0d141d; flex-shrink: 0; }
        .tab {
            flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #888; 
            font-weight: bold; border-bottom: 3px solid transparent; transition: 0.2s;
        }
        .tab.active { color: var(--master-neon); border-bottom-color: var(--master-neon); background: rgba(0, 229, 255, 0.05); }

        /* Chat Layout & Scrolling */
        .chat-wrapper { 
            flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        
        #chat-container { 
            flex: 1; overflow-y: scroll; display: flex; flex-direction: column; gap: 12px;
            padding: 15px; padding-bottom: 110px; /* مساحة للبوكس المثبت */
            -webkit-overflow-scrolling: touch; /* سكرول ناعم جداً للأيفون */
            scroll-behavior: smooth;
        }

        .msg-block { max-width: 85%; padding: 12px; border-radius: 15px; position: relative; animation: fadeIn 0.2s ease-out; line-height: 1.5; }
        .student-msg { align-self: flex-start; background: var(--user-msg); border-bottom-right-radius: 2px; }
        .admin-msg { align-self: flex-end; background: var(--admin-msg); border-bottom-left-radius: 2px; border-right: 3px solid var(--master-neon); }
        
        .msg-image { max-width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
        .msg-video { max-width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
        .file-link { 
            display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); 
            padding: 12px; border-radius: 10px; text-decoration: none; color: var(--master-neon); 
            margin-top: 8px; border: 1px dashed var(--master-neon); font-size: 0.85rem;
        }

        /* Bottom Controls */
        .bottom-controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: #0d141d; border-top: 1px solid #222; padding-bottom: env(safe-area-inset-bottom);
        }
        .preview-bar { 
            background: #111b21; padding: 10px; display: none; align-items: center; gap: 10px; 
            border-top: 2px solid var(--master-neon); 
        }
        .input-area { 
            padding: 10px; display: flex; gap: 8px; align-items: center;
        }
        .input-wrapper { 
            flex: 1; background: #1a2a3a; border-radius: 25px; display: flex; 
            padding: 0 15px; align-items: center; 
        }
        #msg-input { 
            flex: 1; background: transparent; border: none; color: white; padding: 10px 0;
            outline: none; font-size: 1rem;
        }
        .send-btn { 
            width: 45px; height: 45px; background: var(--master-neon); 
            border-radius: 50%; border: none; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="selection-overlay">
        <h2 style="color: var(--master-neon); margin-bottom: 20px;">بماذا تريد البدء؟</h2>
        <div class="select-card" onclick="startApp('public')">
            <i class="fas fa-bullhorn"></i>
            <h3>القناة العامة</h3>
            <p style="color: #888; font-size: 0.8rem; margin-top: 5px;">أحدث تنبيهات وشروحات المستر</p>
        </div>
        <div class="select-card" onclick="startApp('private')">
            <i class="fas fa-comment-medical"></i>
            <h3>المراسلة الخاصة</h3>
            <p style="color: #888; font-size: 0.8rem; margin-top: 5px;">تواصل مباشر وسري مع المستر</p>
        </div>
    </div>

    <div id="blocked-screen">
        <div style="background:#111; padding:30px; border-radius:20px; border:2px solid var(--accent); text-align:center;">
            <i class="fas fa-user-slash" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h2 style="color:var(--accent)">تم حظر حسابك!</h2>
            <a href="https://wa.me/201234567890" style="display:block; margin-top:20px; padding:12px; background:#25d366; color:white; text-decoration:none; border-radius:10px;">تواصل مع المستر</a>
        </div>
    </div>

    <nav>
        <a href="index.html" style="color:white; text-decoration:none;"><i class="fas fa-arrow-right"></i></a>
        <div style="text-align: center;">
            <div id="user-display-name" style="font-weight:900; color:var(--master-neon); font-size:1rem;">جاري التحميل...</div>
            <div id="role-badge" style="font-size:0.7rem; color:#888;">طالب</div>
        </div>
        <div style="width: 25px;"></div>
    </nav>

    <div class="chat-tabs">
        <div id="tab-public" class="tab active" onclick="switchTab('public')">القناة العامة</div>
        <div id="tab-private" class="tab" onclick="switchTab('private')">المراسلة الخاصة</div>
    </div>

    <div class="chat-wrapper">
        <div id="chat-container"></div>

        <div class="bottom-controls">
            <div id="preview-bar" class="preview-bar">
                <div id="file-info" style="font-size:0.8rem; color:var(--master-neon); flex:1; overflow:hidden; text-overflow:ellipsis;"></div>
                <i class="fas fa-times" onclick="cancelAttachment()" style="color:var(--accent)"></i>
            </div>

            <div class="input-area" id="input-section">
                <label class="icon-btn">
                    <i class="fa-solid fa-paperclip" style="color:var(--master-neon); font-size:1.3rem;"></i>
                    <input type="file" id="file-input" hidden onchange="handleFileSelect()">
                </label>
                <div class="input-wrapper">
                    <input type="text" id="msg-input" placeholder="اكتب رسالتك..." autocomplete="off">
                </div>
                <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
            <div id="admin-only-note" style="display:none; text-align:center; padding:12px; color:#888; font-size:0.8rem;">المستر فقط يمكنه النشر هنا</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:e7c9b87205cbb6fb2b4da5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const userPhone = localStorage.getItem('userLoggedIn');
        let userData = null;
        let currentTab = 'public';
        let attachedFileData = null;
        let attachedFileType = null;

        if (!userPhone) window.location.href = "login.html";

        // وظيفة البدء
        function startApp(mode) {
            document.getElementById('selection-overlay').style.fadeOut = "0.3s";
            setTimeout(() => {
                document.getElementById('selection-overlay').style.display = 'none';
                switchTab(mode);
            }, 300);
        }

        // مراقبة بيانات المستخدم
        db.ref('students/' + userPhone).on('value', snap => {
            userData = snap.val();
            if (!userData) return;
            if (userData.status === "blocked") document.getElementById('blocked-screen').style.display = 'flex';
            document.getElementById('user-display-name').innerText = userData.name;
            document.getElementById('role-badge').innerText = userData.role === 'admin' ? 'المدير (المستر)' : 'طالب';
            updateUIForRole();
        });

        function updateUIForRole() {
            const isPublic = currentTab === 'public';
            const isAdmin = userData?.role === 'admin';
            document.getElementById('input-section').style.display = (!isPublic || isAdmin) ? 'flex' : 'none';
            document.getElementById('admin-only-note').style.display = (isPublic && !isAdmin) ? 'block' : 'none';
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '<div style="text-align:center; padding:20px; color:var(--master-neon);">جاري فتح القناة...</div>';
            
            updateUIForRole();
            loadChat();
        }

        function handleFileSelect() {
            const file = document.getElementById('file-input').files[0];
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) return alert("الملف كبير جداً (الأقصى 10 ميجا)");

            const reader = new FileReader();
            reader.onload = (e) => {
                attachedFileData = e.target.result;
                attachedFileType = file.type.startsWith('image/') ? 'image' : file.type.startsWith('video/') ? 'video' : 'file';
                document.getElementById('preview-bar').style.display = 'flex';
                document.getElementById('file-info').innerText = "تم إرفاق: " + file.name;
            };
            reader.readAsDataURL(file);
        }

        function cancelAttachment() {
            attachedFileData = null; attachedFileType = null;
            document.getElementById('file-input').value = "";
            document.getElementById('preview-bar').style.display = 'none';
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const txt = input.value.trim();
            if (!txt && !attachedFileData) return;

            const path = currentTab === 'public' ? 'chats/public' : `chats/private/${userPhone}`;
            const msgData = {
                message: txt,
                media: attachedFileData,
                mediaType: attachedFileType,
                senderName: userData.name,
                senderPhone: userPhone,
                role: userData.role || 'student',
                time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref(path).push(msgData);
            input.value = "";
            cancelAttachment();
        }

        function loadChat() {
            const chatBox = document.getElementById('chat-container');
            const path = currentTab === 'public' ? 'chats/public' : `chats/private/${userPhone}`;
            
            db.ref(path).off();
            db.ref(path).limitToLast(40).on('value', snap => {
                chatBox.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    const isMyMsg = m.senderPhone === userPhone;
                    const div = document.createElement('div');
                    div.className = `msg-block ${isMyMsg ? 'admin-msg' : 'student-msg'}`;
                    
                    let media = "";
                    if (m.media) {
                        if (m.mediaType === 'image') media = `<img src="${m.media}" class="msg-image" onclick="window.open(this.src)">`;
                        else if (m.mediaType === 'video') media = `<video src="${m.media}" controls class="msg-video"></video>`;
                        else media = `<a href="${m.media}" download="file" class="file-link"><i class="fas fa-file-pdf"></i> تحميل الملف المرفق</a>`;
                    }

                    div.innerHTML = `
                        <div style="font-size:0.65rem; color:var(--master-neon); font-weight:bold; margin-bottom:4px;">${m.senderName}</div>
                        <div style="word-break: break-word; font-size:0.95rem;">${m.message}</div>
                        ${media}
                        <span style="font-size:0.6rem; color:#aaa; display:block; margin-top:5px; text-align:left;">${m.time}</span>
                    `;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        // إرسال عبر زر Enter في الموبايل
        document.getElementById('msg-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
