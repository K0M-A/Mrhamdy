<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة مستر حمدي عيد | التواصل المتقدم</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --master-neon: #00e5ff;
            --accent: #ff1744;
            --bg: #05080f;
            --glass-bg: rgba(13, 20, 24, 0.95);
            --user-msg: #005c4b;
            --admin-msg: #202c33;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        
        body { 
            background: radial-gradient(circle at center, #0b141a 0%, #05080f 100%);
            color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* Tabs System */
        .chat-tabs { display: flex; background: #111b21; border-bottom: 1px solid #222; }
        .tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; transition: 0.3s;
            font-weight: bold; border-bottom: 3px solid transparent;
        }
        .tab.active { color: var(--master-neon); border-bottom-color: var(--master-neon); background: rgba(0, 229, 255, 0.05); }

        /* Chat Layout */
        nav { padding: 10px 5%; background: #202c33; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .chat-wrapper { flex: 1; max-width: 900px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        #chat-container { 
            flex: 1; padding: 20px; overflow-y: auto; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            display: flex; flex-direction: column; gap: 12px; 
        }

        /* Message Styling */
        .msg-block { max-width: 85%; padding: 12px; border-radius: 12px; position: relative; animation: fadeIn 0.3s; }
        .student-msg { align-self: flex-start; background: var(--user-msg); border-top-right-radius: 2px; }
        .admin-msg { align-self: flex-end; background: var(--admin-msg); border-top-left-radius: 2px; border: 1px solid #333; }
        
        /* Media Elements */
        .msg-image { max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .msg-video { max-width: 100%; border-radius: 8px; margin-top: 8px; background: #000; }
        .file-link { 
            display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); 
            padding: 10px; border-radius: 8px; text-decoration: none; color: var(--master-neon); margin-top: 8px;
            border: 1px solid var(--master-neon); font-size: 0.9rem;
        }

        .delete-btn {
            position: absolute; top: -8px; left: -8px; background: var(--accent); color: white;
            width: 24px; height: 24px; border-radius: 50%; font-size: 12px; display: none;
            align-items: center; justify-content: center; cursor: pointer; border: 2px solid #05080f; z-index: 10;
        }
        .is-admin .delete-btn { display: flex; }

        /* Input System */
        .preview-bar { 
            background: #111b21; padding: 10px; display: none; align-items: center; gap: 10px; 
            border-top: 2px solid var(--master-neon); 
        }
        .input-area { padding: 12px; background: #202c33; display: flex; gap: 10px; align-items: center; }
        .input-wrapper { flex: 1; background: #2a3942; border-radius: 25px; display: flex; padding: 0 15px; align-items: center; }
        #msg-input { flex: 1; background: transparent; border: none; color: white; padding: 12px; outline: none; }
        
        .icon-btn { color: var(--master-neon); font-size: 1.2rem; cursor: pointer; padding: 5px; }
        .send-btn { width: 45px; height: 45px; background: var(--master-neon); border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        #blocked-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body class="not-admin">

    <div id="blocked-screen">
        <h2 style="color: var(--accent);">عفواً، حسابك محظور</h2>
        <p>تواصل مع الإدارة لفك الحظر</p>
    </div>

    <nav>
        <div>
            <span id="user-display-name" style="font-weight: bold; color: var(--master-neon);">جاري التحميل...</span>
            <div id="role-badge" style="font-size: 0.6rem; color: #888;">طالب</div>
        </div>
        <div style="font-size: 0.8rem;"><i class="fa-solid fa-dna"></i> مستر حمدي عيد</div>
    </nav>

    <div class="chat-tabs">
        <div class="tab active" onclick="switchTab('public', this)">القناة العامة</div>
        <div class="tab" onclick="switchTab('private', this)">مراسلة المستر الخاص</div>
    </div>

    <div class="chat-wrapper">
        <div id="chat-container"></div>

        <div id="preview-bar" class="preview-bar">
            <div id="file-info" style="font-size: 0.8rem; color: var(--master-neon); flex: 1;"></div>
            <i class="fas fa-times" onclick="cancelAttachment()" style="color: var(--accent); cursor: pointer;"></i>
        </div>

        <div class="input-area" id="input-section">
            <label class="icon-btn">
                <i class="fa-solid fa-paperclip"></i>
                <input type="file" id="file-input" hidden onchange="handleFileSelect()">
            </label>
            <div class="input-wrapper">
                <input type="text" id="msg-input" placeholder="اكتب رسالتك..." onkeypress="if(event.key === 'Enter') sendMessage()">
            </div>
            <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane" style="color:#000"></i></button>
        </div>
        <div id="admin-only-note" style="display:none; text-align:center; padding:15px; color:#888; font-size:0.8rem;">
             القناة العامة للقراءة فقط (للمستر فقط)
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // --- إعدادات Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:e7c9b87205cbb6fb2b4da5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const userPhone = localStorage.getItem('userLoggedIn');
        let userData = null;
        let currentTab = 'public';
        let attachedFileData = null;
        let attachedFileType = null;

        if (!userPhone) window.location.href = "login.html";

        // 1. التحقق من الرتبة والصلاحيات
        db.ref('students/' + userPhone).on('value', snap => {
            userData = snap.val();
            if (!userData) return;
            
            if (userData.status === "blocked") {
                document.getElementById('blocked-screen').style.display = 'flex';
            }

            document.getElementById('user-display-name').innerText = userData.name;
            document.getElementById('role-badge').innerText = userData.role === 'admin' ? 'المدير (المستر)' : 'طالب';
            
            if (userData.role === 'admin') {
                document.body.classList.add('is-admin');
            } else {
                document.body.classList.remove('is-admin');
            }
            
            updateUIForRole();
            loadChat(); 
        });

        // 2. تحديث الواجهة
        function updateUIForRole() {
            const inputSection = document.getElementById('input-section');
            const adminNote = document.getElementById('admin-only-note');
            if (currentTab === 'public') {
                if (userData?.role === 'admin') {
                    inputSection.style.display = 'flex';
                    adminNote.style.display = 'none';
                } else {
                    inputSection.style.display = 'none';
                    adminNote.style.display = 'block';
                }
            } else {
                inputSection.style.display = 'flex';
                adminNote.style.display = 'none';
            }
        }

        // 3. معالجة الملفات المرفوعة
        async function handleFileSelect() {
            const file = document.getElementById('file-input').files[0];
            if (!file) return;

            // كود ضغط الصور إذا كان الملف صورة
            if (file.type.startsWith('image/')) {
                attachedFileType = 'image';
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachedFileData = e.target.result; // يمكنك هنا إضافة دالة ضغط الصور لتوفير المساحة
                    showPreview("صورة جاهزة للرفع");
                };
                reader.readAsDataURL(file);
            } 
            else if (file.type.startsWith('video/')) {
                attachedFileType = 'video';
                if (file.size > 20 * 1024 * 1024) { // 20MB Max
                    alert("الفيديو كبير جداً، الحد الأقصى 20 ميجا");
                    cancelAttachment();
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachedFileData = e.target.result;
                    showPreview("فيديو جاهز للرفع");
                };
                reader.readAsDataURL(file);
            }
            else {
                attachedFileType = 'file';
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachedFileData = e.target.result;
                    showPreview(`ملف: ${file.name}`);
                };
                reader.readAsDataURL(file);
            }
        }

        function showPreview(text) {
            document.getElementById('preview-bar').style.display = 'flex';
            document.getElementById('file-info').innerText = text;
        }

        function cancelAttachment() {
            attachedFileData = null;
            attachedFileType = null;
            document.getElementById('file-input').value = "";
            document.getElementById('preview-bar').style.display = 'none';
        }

        // 4. إرسال الرسالة مع المرفقات
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const messageText = input.value.trim();
            
            if (!messageText && !attachedFileData) return;

            const path = currentTab === 'public' ? 'chats/public' : `chats/private/${userPhone}`;
            
            const msgData = {
                message: messageText,
                media: attachedFileData,
                mediaType: attachedFileType,
                senderName: userData.name,
                senderPhone: userPhone,
                role: userData.role || 'student',
                time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref(path).push(msgData);
            
            // تصفير المدخلات
            input.value = "";
            cancelAttachment();
        }

        // 5. تحميل وعرض الرسائل
        function loadChat() {
            const chatBox = document.getElementById('chat-container');
            const path = currentTab === 'public' ? 'chats/public' : `chats/private/${userPhone}`;
            
            db.ref(path).off();
            db.ref(path).limitToLast(40).on('value', snap => {
                chatBox.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `msg-block ${m.role === 'admin' ? 'admin-msg' : 'student-msg'}`;
                    
                    let mediaHtml = "";
                    if (m.media) {
                        if (m.mediaType === 'image') {
                            mediaHtml = `<img src="${m.media}" class="msg-image" onclick="window.open(this.src)">`;
                        } else if (m.mediaType === 'video') {
                            mediaHtml = `<video src="${m.media}" controls class="msg-video"></video>`;
                        } else {
                            mediaHtml = `<a href="${m.media}" download="file" class="file-link"><i class="fas fa-file-pdf"></i> تحميل الملف المرفق</a>`;
                        }
                    }

                    let deleteHtml = userData?.role === 'admin' ? 
                        `<div class="delete-btn" onclick="deleteMsg('${child.key}')"><i class="fas fa-times"></i></div>` : '';

                    msgDiv.innerHTML = `
                        ${deleteHtml}
                        <div style="font-size:0.65rem; color:var(--master-neon); font-weight:bold; margin-bottom:4px;">${m.senderName}</div>
                        <div style="word-break: break-word;">${m.message}</div>
                        ${mediaHtml}
                        <span style="font-size:0.6rem; color:#888; display:block; margin-top:5px;">${m.time}</span>
                    `;
                    chatBox.appendChild(msgDiv);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function switchTab(tab, element) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            updateUIForRole();
            loadChat();
        }

        function deleteMsg(msgId) {
            if (!confirm("حذف هذه الرسالة نهائياً؟")) return;
            const path = currentTab === 'public' ? 'chats/public' : `chats/private/${userPhone}`;
            db.ref(`${path}/${msgId}`).remove();
        }
    </script>
</body>
</html>
