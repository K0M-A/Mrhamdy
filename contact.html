<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة مستر حمدي عيد | التواصل المتقدم</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --master-neon: #00e5ff;
            --accent: #ff1744;
            --bg: #05080f;
            --glass-bg: rgba(20, 30, 40, 0.95);
            --user-msg: #1a2a3a;
            --admin-msg: #004d40;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        
        body { 
            background: var(--bg);
            color: var(--text); 
            height: 100vh; 
            height: -webkit-fill-available;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Blocked Screen UI */
        #blocked-screen { 
            position: fixed; 
            inset: 0; 
            background: rgba(5, 8, 15, 0.98); 
            z-index: 9999; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
            text-align: center;
            padding: 20px;
        }
        .blocked-card {
            background: #111;
            padding: 30px;
            border-radius: 20px;
            border: 2px solid var(--accent);
            box-shadow: 0 0 20px rgba(255, 23, 68, 0.2);
        }

        /* Navigation */
        nav { 
            padding: 15px 5%; 
            background: #0d141d; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #222;
        }
        .back-btn {
            background: rgba(255,255,255,0.05);
            padding: 8px 15px;
            border-radius: 8px;
            color: var(--text);
            text-decoration: none;
            font-size: 0.9rem;
            transition: 0.3s;
        }

        /* Tabs System */
        .chat-tabs { display: flex; background: #0d141d; }
        .tab {
            flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #888; transition: 0.3s;
            font-weight: bold; border-bottom: 3px solid transparent;
        }
        .tab.active { color: var(--master-neon); border-bottom-color: var(--master-neon); background: rgba(0, 229, 255, 0.05); }

        /* Chat Layout */
        .chat-wrapper { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative;
            background: #05080f; /* تم إزالة صورة الواتساب */
        }
        
        #chat-container { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            padding-bottom: 100px; /* مساحة لضمان عدم اختفاء الرسائل خلف صندوق الإرسال */
        }

        /* Message Styling */
        .msg-block { max-width: 85%; padding: 12px; border-radius: 12px; position: relative; animation: fadeIn 0.3s; }
        .student-msg { align-self: flex-start; background: var(--user-msg); border-top-right-radius: 2px; }
        .admin-msg { align-self: flex-end; background: var(--admin-msg); border-top-left-radius: 2px; border: 1px solid var(--master-neon); }
        
        /* Media Elements */
        .msg-image { max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer; }
        .msg-video { max-width: 100%; border-radius: 8px; margin-top: 8px; }
        .file-link { 
            display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); 
            padding: 10px; border-radius: 8px; text-decoration: none; color: var(--master-neon); margin-top: 8px;
            border: 1px solid var(--master-neon); font-size: 0.8rem;
        }

        .delete-btn {
            position: absolute; top: -8px; left: -8px; background: var(--accent); color: white;
            width: 22px; height: 22px; border-radius: 50%; font-size: 10px; display: none;
            align-items: center; justify-content: center; cursor: pointer; border: 2px solid #05080f;
        }
        .is-admin .delete-btn { display: flex; }

        /* Input System (Fixed at Bottom) */
        .bottom-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0d141d;
            border-top: 1px solid #222;
            z-index: 100;
        }

        .preview-bar { 
            background: #111b21; padding: 10px; display: none; align-items: center; gap: 10px; 
            border-top: 2px solid var(--master-neon); 
        }

        .input-area { 
            padding: 10px 5%; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            max-width: 900px; 
            margin: 0 auto;
        }

        .input-wrapper { 
            flex: 1; 
            background: #1a2a3a; 
            border-radius: 25px; 
            display: flex; 
            padding: 2px 15px; 
            align-items: center; 
        }

        #msg-input { 
            flex: 1; 
            background: transparent; 
            border: none; 
            color: white; 
            padding: 12px; 
            outline: none; 
            font-size: 0.95rem;
        }
        
        .icon-btn { color: var(--master-neon); font-size: 1.2rem; cursor: pointer; }
        .send-btn { 
            width: 45px; height: 45px; 
            background: var(--master-neon); 
            border-radius: 50%; border: none; 
            cursor: pointer; display: flex; 
            align-items: center; justify-content: center; 
            transition: 0.3s;
        }
        .send-btn:active { transform: scale(0.9); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="not-admin">

    <div id="blocked-screen">
        <div class="blocked-card">
            <i class="fas fa-user-slash" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h2 style="color: var(--accent); margin-bottom: 10px;">عفواً، تم حظر حسابك!</h2>
            <p style="color: #ccc; margin-bottom: 20px;">لقد تم تقييد وصولك للمنصة من قبل الإدارة.<br>يرجى تقديم اعتذار أو التواصل مع المستر لفك الحظر.</p>
            <a href="https://wa.me/201234567890" style="display: inline-block; padding: 12px 25px; background: #25d366; color: white; text-decoration: none; border-radius: 10px; font-weight: bold;">
                <i class="fab fa-whatsapp"></i> تواصل مع المستر الآن
            </a>
        </div>
    </div>

    <nav>
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-right"></i> الرئيسية</a>
        <div style="text-align: left;">
            <span id="user-display-name" style="font-weight: bold; color: var(--master-neon); font-size: 0.9rem;">جاري التحميل...</span>
            <div id="role-badge" style="font-size: 0.6rem; color: #888;">طالب</div>
        </div>
    </nav>

    <div class="chat-tabs">
        <div class="tab active" onclick="switchTab('public', this)">القناة العامة</div>
        <div class="tab" onclick="switchTab('private', this)">المراسلة الخاصة</div>
    </div>

    <div class="chat-wrapper">
        <div id="chat-container"></div>

        <div class="bottom-controls">
            <div id="preview-bar" class="preview-bar">
                <div id="file-info" style="font-size: 0.8rem; color: var(--master-neon); flex: 1;"></div>
                <i class="fas fa-times" onclick="cancelAttachment()" style="color: var(--accent); cursor: pointer;"></i>
            </div>

            <div class="input-area" id="input-section">
                <label class="icon-btn">
                    <i class="fa-solid fa-paperclip"></i>
                    <input type="file" id="file-input" hidden onchange="handleFileSelect()">
                </label>
                <div class="input-wrapper">
                    <input type="text" id="msg-input" placeholder="اكتب رسالتك..." onkeypress="if(event.key === 'Enter') sendMessage()">
                </div>
                <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane" style="color:#000"></i></button>
            </div>
            
            <div id="admin-only-note" style="display:none; text-align:center; padding:15px; color:#888; font-size:0.8rem; background: #0d141d;">
                 المستر فقط يمكنه النشر في القناة العامة
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        // --- إعدادات Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCcFRLMsewcgYXYgVvdkyQHf-imoJHHzng",
            authDomain: "mrhamdy-1c406.firebaseapp.com",
            databaseURL: "https://mrhamdy-1c406-default-rtdb.firebaseio.com",
            projectId: "mrhamdy-1c406",
            storageBucket: "mrhamdy-1c406.firebasestorage.app",
            messagingSenderId: "806268398144",
            appId: "1:806268398144:web:e7c9b87205cbb6fb2b4da5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const userPhone = localStorage.getItem('userLoggedIn');
        let userData = null;
        let currentTab = 'public';
        let attachedFileData = null;
        let attachedFileType = null;

        if (!userPhone) window.location.href = "login.html";

        // 1. مراقبة بيانات المستخدم والحظر
        db.ref('students/' + userPhone).on('value', snap => {
            userData = snap.val();
            if (!userData) return;
            
            if (userData.status === "blocked") {
                document.getElementById('blocked-screen').style.display = 'flex';
            } else {
                document.getElementById('blocked-screen').style.display = 'none';
            }

            document.getElementById('user-display-name').innerText = userData.name;
            document.getElementById('role-badge').innerText = userData.role === 'admin' ? 'المدير (المستر)' : 'طالب';
            
            if (userData.role === 'admin') {
                document.body.classList.add('is-admin');
            } else {
                document.body.classList.remove('is-admin');
            }
            
            updateUIForRole();
            loadChat(); 
        });

        // 2. إدارة صلاحيات الإرسال
        function updateUIForRole() {
            const inputSection = document.getElementById('input-section');
            const adminNote = document.getElementById('admin-only-note');
            
            if (currentTab === 'public') {
                // في القناة العامة: الإرسال للمستر فقط
                if (userData?.role === 'admin') {
                    inputSection.style.display = 'flex';
                    adminNote.style.display = 'none';
                } else {
                    inputSection.style.display = 'none';
                    adminNote.style.display = 'block';
                }
            } else {
                // في الخاص: الجميع يرسل
                inputSection.style.display = 'flex';
                adminNote.style.display = 'none';
            }
        }

        // 3. معالجة الملفات
        function handleFileSelect() {
            const file = document.getElementById('file-input').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                attachedFileData = e.target.result;
                if (file.type.startsWith('image/')) attachedFileType = 'image';
                else if (file.type.startsWith('video/')) attachedFileType = 'video';
                else attachedFileType = 'file';
                
                showPreview(file.name);
            };
            reader.readAsDataURL(file);
        }

        function showPreview(text) {
            document.getElementById('preview-bar').style.display = 'flex';
            document.getElementById('file-info').innerText = text;
        }

        function cancelAttachment() {
            attachedFileData = null;
            attachedFileType = null;
            document.getElementById('file-input').value = "";
            document.getElementById('preview-bar').style.display = 'none';
        }

        // 4. إرسال الرسالة
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const messageText = input.value.trim();
            if (!messageText && !attachedFileData) return;

            // إذا كان المستخدم طالب، الخاص يذهب لمجلد هاتفه، وإذا كان مستر، يرسل في نفس المحادثة
            const path = currentTab === 'public' ? 'chats/public' : `chats/private/${userPhone}`;
            
            const msgData = {
                message: messageText,
                media: attachedFileData,
                mediaType: attachedFileType,
                senderName: userData.name,
                senderPhone: userPhone,
                role: userData.role || 'student',
                time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref(path).push(msgData);
            input.value = "";
            cancelAttachment();
        }

        // 5. تحميل الرسائل
        function loadChat() {
            const chatBox = document.getElementById('chat-container');
            const path = currentTab === 'public' ? 'chats/public' : `chats/private/${userPhone}`;
            
            db.ref(path).off();
            db.ref(path).limitToLast(50).on('value', snap => {
                chatBox.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    const msgDiv = document.createElement('div');
                    
                    // تحديد التموضع: المستر دائماً يمين في كل الحالات؟ 
                    // لا، الأفضل: رسائلي أنا يمين، والآخر يسار
                    const isMyMsg = m.senderPhone === userPhone;
                    msgDiv.className = `msg-block ${isMyMsg ? 'admin-msg' : 'student-msg'}`;
                    
                    let mediaHtml = "";
                    if (m.media) {
                        if (m.mediaType === 'image') mediaHtml = `<img src="${m.media}" class="msg-image" onclick="window.open(this.src)">`;
                        else if (m.mediaType === 'video') mediaHtml = `<video src="${m.media}" controls class="msg-video"></video>`;
                        else mediaHtml = `<a href="${m.media}" download="file" class="file-link"><i class="fas fa-file-pdf"></i> ملف مرفق</a>`;
                    }

                    let deleteHtml = userData?.role === 'admin' ? 
                        `<div class="delete-btn" onclick="deleteMsg('${child.key}')"><i class="fas fa-times"></i></div>` : '';

                    msgDiv.innerHTML = `
                        ${deleteHtml}
                        <div style="font-size:0.65rem; color:var(--master-neon); font-weight:bold; margin-bottom:4px;">${m.senderName}</div>
                        <div style="word-break: break-word;">${m.message}</div>
                        ${mediaHtml}
                        <span style="font-size:0.6rem; color:#888; display:block; margin-top:5px; text-align:left;">${m.time}</span>
                    `;
                    chatBox.appendChild(msgDiv);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function switchTab(tab, element) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            updateUIForRole();
            loadChat();
        }

        function deleteMsg(msgId) {
            if (!confirm("حذف الرسالة؟")) return;
            const path = currentTab === 'public' ? 'chats/public' : `chats/private/${userPhone}`;
            db.ref(`${path}/${msgId}`).remove();
        }
    </script>
</body>
</html>
